<html>
    <head>
<script>


var myCharacteristic;

let UARTService = "000000ff-0000-1000-8000-00805f9b34fb"
let UARTCharRxTx = "0000ff01-0000-1000-8000-00805f9b34fb"



function hexStringToArrayBuffer(hexString) {
    // remove the leading 0x
    hexString = hexString.replace(/^0x/, '');
    
    // ensure even number of characters
    if (hexString.length % 2 != 0) {
        console.log('WARNING: expecting an even number of characters in the hexString');
    }
    
    // check for some non-hex characters
    var bad = hexString.match(/[G-Z\s]/i);
    if (bad) {
        console.log('WARNING: found non-hex characters', bad);    
    }
    
    // split the string into pairs of octets
    var pairs = hexString.match(/[\dA-F]{2}/gi);
    
    // convert the octets to integers
    var integers = pairs.map(function(s) {
        return parseInt(s, 16);
    });
    
    var array = new Uint8Array(integers);
    //console.log(array);
    
    return array.buffer;
}

async function onReadButtonClick() {

    try {

        //let filters = [];
        //filters.push({namePrefix: 'QMN000B'});


        log_msg('Requesting Bluetooth Device...');
        const device = await navigator.bluetooth.requestDevice({
            filters: [{namePrefix: 'QMN000B'}], optionalServices: [UARTService]});

        log_msg('Connecting to GATT Server...');
        const server = await device.gatt.connect();

        log_msg('Getting Service...');
        const service = await server.getPrimaryService(UARTService);

        log_msg('Getting Characteristic...');
        const characteristic = await service.getCharacteristic(UARTCharRX);

        myCharacteristic = characteristic
        await myCharacteristic.startNotifications().then(_ => {
        log_msg('> Notifications started');
        myCharacteristic.addEventListener('characteristicvaluechanged',
            handleNotifications);
        });
        
        log_msg('Setting Characteristic User Description...');

    } catch(error) {
        log_msg('Error! ' + error);
    }
}

function handleNotifications(event) {
    let value = event.target.value;
    let a = [];

    for (let i = 0; i < value.byteLength; i++) {
        a.push(('00' + value.getUint8(i).toString(16)).slice(-2));
    }
    log_msg(value.byteLength+' > ' + a.join(' '));
}

function sendMsg(text) {
    lolog_msg('< ' + text)
    myCharacteristic.writeValue(hexStringToArrayBuffer(text))
}

function log_msg(logtext) {
    logSelect = document.getElementById('log');
    logSelect.options[logSelect.options.length] = new Option(logtext);
}



</script>
</head>
<body>

<button onclick="onReadButtonClick();">Connect</button>
&nbsp;&nbsp;
<button onclick="sendMsg('004800060034011809db28bc2b2e7c802686e16267ace394acbcaca564be2a1390306706884c8d9a2b9b9cac2599c13f42cbff2228c8a673d1460d948572fe8ed234ae0463dc6fc2d75b');">Send auth</button>
<br /><br />
<button onclick="sendMsg('00280006001601173dbc415207dbb6d220bc9405c0d1a771503ee5dd5bb9dc1b298160f5d6cbb6b615b7');">Send write register 0 -> 0</button>
<br /><br />
<button onclick="sendMsg('00280006001601179d356d59a2ee6e598e6872015db340978833e1bb481b8ca7fac7fc8f07ebdfa32b35');">Send write register 121 -> 6</button>
&nbsp;&nbsp;
<button onclick="sendMsg('00280006001601179d356d59a2ee6e598e6872015db3409768a1235e8f9af74ac106e1fc7fcec58ebd30');">Send write register 121 -> 8</button>
&nbsp;&nbsp;
<button onclick="sendMsg('00280006001601179d356d59a2ee6e598e6872015db340970d483c28d05e4ab0a80b78804ce6f76ae947');">Send write register 121 -> 10</button>
<br /><br />
<button onclick="sendMsg('00280006001601173dbc415207dbb6d220bc9405c0d1a771c983ca9824710da815e71f91d1ccd3b986ef');">Send write register 0 -> 1</button>
&nbsp;&nbsp;
<br>
<br>
<br>
<select id ="log" size="30" style="width: 750px;" multiple>



</select>

</body>
</html>
